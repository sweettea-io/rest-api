#!/bin/bash

# --- Run supported application as either a Go binary or Docker image (and potentially as a daemon if Docker image) --- #

# ======== PARSE ARGS ======== #

this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
app="$1"
run_type="$2"
run_as_daemon="$3"
go_build_output_dir="./bin"
apps_dir="./cmd"
envs_dir="./envs"
run_env="local"

# ======== VALIDATE ARGS ======== #

$this_dir/validate_arg "target" "$app" "server|migrate|worker"
$this_dir/validate_arg "format" "$run_type" "image|binary|file"

# ======== RUN LOCAL APP ======== #

# Run app as a Docker image.
if [[ "$run_type" = "image" ]]; then
	# Get Docker image name for 'local' env tier.
	image_name=$( $this_dir/env_reader "$app" "$run_env" "IMAGE_NAME" )

	# Build up args for 'docker run' command.
	cmd_args="--env-file $envs_dir/$run_env/$app.env"

	# Add port binding for 'server' app.
	if [[ "$app" = "server" ]]; then
		server_port=$( $this_dir/env_reader "$app" "$run_env" "SERVER_PORT" )
		cmd_args="$cmd_args -p $server_port:$server_port"
	fi

	# Run as daemon if desired.
	if [[ "$run_as_daemon" = "true" ]]; then
		cmd_args="$cmd_args -d"
	fi

	# Run Docker image.
	docker run "$image_name" "$cmd_args"

elif [[ "$run_type" = "binary" ]]; then
	# Run app as Go binary.
	$go_build_output_dir/$app
else
	# Run app as Go file.
	go run "$apps_dir/$app/main.go"
fi