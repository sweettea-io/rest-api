#!/bin/bash

# ======== PARSE ARGS ======== #

this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
provider="$1"
type="$2"
upper_type="${type^^}"
env="$3"
zones="$4"
master_size="$5"
node_size="$6"
node_count="$7"
state="$8"
image="$9"
k8s_version="$9"

# ======== VALIDATE ARGS ======== #

$this_dir/validate_arg "$provider" "aws" "provider"
$this_dir/validate_arg "$type" "core|build|train" "type"
$this_dir/validate_arg "$env" "local|dev|staging|prod" "env"

# ======== SETUP FALLBACK ARG VALUES ======== #

# Read envs from server.env for the provided $env
app_for_env_reading="server"

# Get env vals
cluster_name=$( $this_dir/env_reader "$app_for_env_reading" "$env" "${upper_type}_CLUSTER_NAME" )
zones_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "AWS_REGION_NAME" )
master_size_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "MASTER_SIZE" )
node_size_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "NODE_SIZE" )
node_count_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "NODE_COUNT" )
state_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "${upper_type}_CLUSTER_STATE" )
image_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "CLUSTER_IMAGE" )
k8s_version_env_val=$( $this_dir/env_reader "$app_for_env_reading" "$env" "K8S_VERSION" )

# Fallback vals -- Assign env vals
zones="${zones:-$zones_env_val}"
master_size="${master_size:-$master_size_env_val}"
node_size="${node_size:-$node_size_env_val}"
node_count="${node_count:-$node_count_env_val}"
state="${state:-$state_env_val}"
image="${image:-$image_env_val}"
k8s_version="${k8s_version:-$k8s_version_env_val}"

# Fallback vals #2
zones="${zones:-us-west-1a}"
master_size="${master_size:-t2.micro}"
node_size="${node_size:-t2.micro}"
node_count="${node_count:-2}"
image="${image:-099720109477/ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20171026.1}"
k8s_version="${k8s_version:-1.7.10}"

#TODO: Add args to these calls
$this_dir/$provider/create_group
$this_dir/$provider/create_user
$this_dir/$provider/configure_user
$this_dir/$provider/create_bucket
$this_dir/$provider/create_hosted_zone
$this_dir/$provider/create_cluster